<template>
  <form @submit.prevent="submitReservation">
    <h2>イベント: {{ eventDetails.title }}</h2>
    <p>{{ eventDetails.description }}</p>
    <p>日時: {{ eventDetails.date }}</p>
    <br>
    <label>氏名: <input v-model="name" required /></label>
    <br>
    <label>学部:
      <select v-model="faculty">
        <option value="sys">システム工学部</option>
        <option value="edu">教育学部</option>
        <option value="eco">経済学部</option>
        <option value="tou">観光学部</option>
        <option value="soc">社会インフォマティクス学環</option>
      </select>
    </label>
    <br>
    <label>性別:
      <select v-model="gender">
        <option value="male">男性</option>
        <option value="female">女性</option>
      </select>
    </label>
    <br>
    <button type="submit">予約する</button>
  </form>
</template>

<script>
import { ref, onMounted } from 'vue';
import { collection, doc, getDoc, addDoc } from 'firebase/firestore';  // addDoc をインポート
import { db } from '@/firebase';
import { useRoute } from 'vue-router';

export default {
  setup() {
    const name = ref('');
    const faculty = ref('');
    const gender = ref('male');
    const eventDetails = ref({});
    const route = useRoute(); // ルート情報を取得

    // イベントIDを元にイベントの詳細を取得
    const fetchEventDetails = async () => {
      const eventId = route.query.eventId;
      if (eventId) {
        try {
          const docRef = doc(db, 'events', eventId);  // イベントのドキュメント参照
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            eventDetails.value = docSnap.data();
          } else {
            console.log('No such event!');
          }
        } catch (error) {
          console.error('Error fetching event details:', error);
        }
      }
    };

    // 予約の処理
    const submitReservation = async () => {
      try {
        // 予約情報を reservations コレクションに追加
        await addDoc(collection(db, 'reservations'), {
          name: name.value,
          faculty: faculty.value,
          gender: gender.value,
          eventId: route.query.eventId, // イベントIDも保存
          createdAt: new Date(), // 予約時刻
        });
        alert('予約完了');
      } catch (error) {
        console.error('Error submitting reservation:', error);
        alert('予約に失敗しました');
      }
    };

    onMounted(fetchEventDetails);

    return { name, faculty, gender, submitReservation, eventDetails };
  }
};
</script>